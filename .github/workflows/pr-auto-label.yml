name: PR Auto-Label

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  size-label:
    name: Set Size Label
    runs-on: ubuntu-latest
    steps:
      - name: Calculate PR size and set label
        run: |
          # Fetch file changes for this PR
          FILES=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files --paginate)

          # Calculate lines by category (excluding uv.lock and cassettes)
          CODE=$(echo "$FILES" | jq '[.[] | select(
            (.filename | (startswith("tests/") or startswith("docs/") or endswith(".md")) | not) and
            (.filename != "uv.lock") and
            (.filename | contains("/cassettes/") | not)
          ) | .additions + .deletions] | add // 0')

          DOCS=$(echo "$FILES" | jq '[.[] | select(
            (.filename | (startswith("docs/") or endswith(".md"))) and
            (.filename != "uv.lock") and
            (.filename | contains("/cassettes/") | not)
          ) | .additions + .deletions] | add // 0')

          TESTS=$(echo "$FILES" | jq '[.[] | select(
            (.filename | startswith("tests/")) and
            (.filename | contains("/cassettes/") | not) and
            (.filename | endswith(".md") | not)
          ) | .additions + .deletions] | add // 0')

          # Calculate weighted score: code + 50% docs + 50% tests
          SCORE=$((CODE + DOCS / 2 + TESTS / 2))

          echo "Code: $CODE, Docs: $DOCS, Tests: $TESTS"
          echo "Weighted score: $SCORE"

          # Determine size label based on cutoffs
          if [ $SCORE -le 100 ]; then
            SIZE="size: S"
          elif [ $SCORE -le 500 ]; then
            SIZE="size: M"
          elif [ $SCORE -le 1500 ]; then
            SIZE="size: L"
          else
            SIZE="size: XL"
          fi

          echo "Size: $SIZE"

          # Remove any existing size labels (except the one we're setting) via API
          for label in "size: S" "size: M" "size: L" "size: XL"; do
            if [ "$label" != "$SIZE" ]; then
              gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels/${label}" --method DELETE 2>/dev/null || true
            fi
          done

          # Add the new size label via API
          gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels" --method POST -f "labels[]=$SIZE"

          echo "✅ Set label: $SIZE (score: $SCORE)"
        env:
          GH_TOKEN: ${{ github.token }}

  category-label:
    name: Set Category Label
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Check if category label already exists
        id: check-label
        run: |
          LABELS=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          CATEGORY_LABELS=("bug" "feature" "docs" "chore")

          for label in "${CATEGORY_LABELS[@]}"; do
            if echo "$LABELS" | grep -q "^${label}$"; then
              echo "has_label=true" >> $GITHUB_OUTPUT
              echo "✅ PR already has category label: $label"
              exit 0
            fi
          done

          echo "has_label=false" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout repository
        if: steps.check-label.outputs.has_label == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Determine category label with Claude Code
        if: steps.check-label.outputs.has_label == 'false'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: "5"
          direct_prompt: |
            Analyze this PR and classify it into exactly ONE of these categories by adding the appropriate label:

            - `bug`: Fixes something that isn't working correctly
            - `feature`: Adds new functionality or capabilities
            - `docs`: Documentation-only changes (no functional code changes)
            - `chore`: Maintenance, refactoring, dependencies, CI/CD, or test-only changes

            Guidelines:
            - Look at the actual files changed, not just the PR title
            - If code AND docs are changed, prefer `feature` or `bug` over `docs`
            - Test-only changes (without functional code) are `chore`
            - Dependency updates are `chore`
            - CI/workflow changes are `chore`
            - Refactoring without new functionality is `chore`

            After analyzing, add exactly ONE label using the GitHub API:
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels --method POST -f "labels[]=<category>"

            Only output the gh command you ran and a brief explanation of why you chose that category.
