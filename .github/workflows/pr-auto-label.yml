name: PR Auto-Label

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write        # Required for GitHub Issues API (PR labels)
  pull-requests: write # Required for PR operations

jobs:
  size-label:
    name: Set Size Label
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Calculate PR size and set label
        run: |
          # Fetch file changes for this PR
          FILES=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files --paginate)

          # Calculate lines by category (excluding uv.lock and cassettes)
          CODE=$(echo "$FILES" | jq '[.[] | select(
            (.filename | (startswith("tests/") or startswith("docs/") or endswith(".md")) | not) and
            (.filename != "uv.lock") and
            (.filename | contains("/cassettes/") | not)
          ) | .additions + .deletions] | add // 0')

          DOCS=$(echo "$FILES" | jq '[.[] | select(
            (.filename | (startswith("docs/") or endswith(".md"))) and
            (.filename != "uv.lock") and
            (.filename | contains("/cassettes/") | not)
          ) | .additions + .deletions] | add // 0')

          TESTS=$(echo "$FILES" | jq '[.[] | select(
            (.filename | startswith("tests/")) and
            (.filename | contains("/cassettes/") | not) and
            (.filename | endswith(".md") | not)
          ) | .additions + .deletions] | add // 0')

          # Calculate weighted score: code + 50% docs + 50% tests
          SCORE=$((CODE + DOCS / 2 + TESTS / 2))

          echo "Code: $CODE, Docs: $DOCS, Tests: $TESTS"
          echo "Weighted score: $SCORE"

          # Determine size label based on cutoffs
          if [ $SCORE -le 100 ]; then
            SIZE="size: S"
          elif [ $SCORE -le 500 ]; then
            SIZE="size: M"
          elif [ $SCORE -le 1500 ]; then
            SIZE="size: L"
          else
            SIZE="size: XL"
          fi

          echo "Size: $SIZE"

          # Remove any existing size labels (except the one we're setting) via API
          for label in "size: S" "size: M" "size: L" "size: XL"; do
            if [ "$label" != "$SIZE" ]; then
              gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels/${label}" --method DELETE 2>/dev/null || true
            fi
          done

          # Add the new size label via API
          gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels" --method POST -f "labels[]=$SIZE"

          echo "Set label: $SIZE (score: $SCORE)"
        env:
          GH_TOKEN: ${{ github.token }}

  category-label:
    name: Set Category Label
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Check if category label already exists
        id: check-label
        run: |
          LABELS=$(gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          CATEGORY_LABELS=("bug" "feature" "docs" "chore" "dependency")

          for label in "${CATEGORY_LABELS[@]}"; do
            if echo "$LABELS" | grep -q "^${label}$"; then
              echo "has_label=true" >> $GITHUB_OUTPUT
              echo "PR already has category label: $label"
              exit 0
            fi
          done

          echo "has_label=false" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout repository
        if: steps.check-label.outputs.has_label == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Determine category label with Claude Code
        if: steps.check-label.outputs.has_label == 'false'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          timeout_minutes: "5"
          direct_prompt: |
            Analyze this PR and classify it into exactly ONE of these categories by adding the appropriate label:

            - `bug`: Fixes something that isn't working correctly
            - `feature`: Adds new functionality or capabilities
            - `docs`: Documentation-only changes (no functional code changes)
            - `chore`: Maintenance, refactoring, dev dependencies, CI/CD, or test-only changes
            - `dependency`: Production dependency updates

            Guidelines:
            - Look at the actual files changed, not just the PR title
            - If code AND docs are changed, prefer `feature` or `bug` over `docs`
            - Test-only changes (without functional code) are `chore`
            - Production dependency updates (in `[project.dependencies]` or `[project.optional-dependencies]`) are `dependency`
            - Dev-only dependency updates (in `[dependency-groups]`) are `chore`
            - CI/workflow changes are `chore`
            - Refactoring without new functionality is `chore`

            After analyzing, add exactly ONE label using the GitHub API:
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels --method POST -f "labels[]=<category>"

            Only output the gh command you ran and a brief explanation of why you chose that category.

  add-label-from-comment:
    name: Add Label from Comment
    # Allows maintainers to override the auto-assigned category label via `/label <name>` comment.
    # This job removes any existing category label before applying the new one,
    # so `/label bug` on a PR labeled `chore` will replace `chore` with `bug`.
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && startsWith(github.event.comment.body, '/label ')
    runs-on: ubuntu-latest
    steps:
      - name: Add label from comment
        uses: actions/github-script@v7
        with:
          script: |
            const categoryLabels = ['bug', 'feature', 'docs', 'chore', 'dependency'];
            const comment = context.payload.comment.body.trim();
            const match = comment.match(/^\/label\s+(\S+)/);

            if (!match) {
              console.log('No label found in comment');
              return;
            }

            const requestedLabel = match[1].toLowerCase();
            const prNumber = context.payload.issue.number;

            if (!categoryLabels.includes(requestedLabel)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `❌ \`${requestedLabel}\` is not a valid label. Allowed labels are: ${categoryLabels.map(l => '\`' + l + '\`').join(', ')}`
              });
              return;
            }

            try {
              // Remove any existing category labels before adding the new one
              const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });

              for (const label of currentLabels) {
                if (categoryLabels.includes(label.name) && label.name !== requestedLabel) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    name: label.name
                  });
                }
              }

              // Add the requested label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: [requestedLabel]
              });

              // React with +1 to indicate success
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: '+1'
              });

              console.log(`✅ Set label: ${requestedLabel}`);
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `❌ Failed to add label \`${requestedLabel}\`: ${error.message}`
              });
            }
